<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Criador de Sequência – Stories/Carrossel (v2.9 Left Controls + Custom Scrollbar)</title>
<style>
  :root{
    --bg:#0a0a0a; --fg:#fafafa; --muted:#bdbdbd;
    --panel:#121212;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--fg); background:linear-gradient(180deg,#0b0b0b,#0e0e0e);
    display:grid;
    grid-template-columns:minmax(360px, 520px) 1fr;
    grid-template-areas: "controls preview";
    gap:16px; padding:16px; height:100vh;
  }

  /* Tabs (visíveis apenas no mobile) */
  .tabs{display:none; grid-area: tabs;}
  .tab-btn{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #242424;
           background:#181818; color:#eaeaea; font-weight:800; text-align:center}
  .tab-btn.active{ background:#f5f5f5; color:#111; border-color:#f5f5f5 }

  @media (max-width: 900px){
    body{
      grid-template-columns:1fr;
      grid-template-rows:auto auto 1fr;
      grid-template-areas: "tabs" "controls" "preview";
      gap:10px; padding:10px; height:100svh;
    }
    .tabs{
      display:flex; background:#121212; border:1px solid #1f1f1f; border-radius:12px; padding:6px;
      position:sticky; top:10px; z-index:6; gap:6px;
    }
    /* alternância de painéis por aba */
    body[data-tab="preview"] #controls{display:none}
    body[data-tab="ajustes"] .preview-wrap{display:none}
  }

  /* Painéis */
  .panel{background:var(--panel); border:1px solid #1f1f1f; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:auto}
  #controls{ grid-area: controls; }
  .preview-wrap{ grid-area: preview; background:#121212; border:1px solid #1f1f1f; border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:auto; height:calc(100vh - 32px);}
  .panel h2{margin:4px 0 12px; font-size:18px}

  /* Custom scrollbar (somente área de ajustes) */
  #controls{ scrollbar-width: thin; scrollbar-color: #3a3a3a #101010; }
  #controls::-webkit-scrollbar{ width:12px }
  #controls::-webkit-scrollbar-track{ background:linear-gradient(180deg,#101010,#0b0b0b); border-radius:10px }
  #controls::-webkit-scrollbar-thumb{
    background:linear-gradient(180deg,#2a2a2a,#3c3c3c);
    border-radius:10px; border:2px solid #101010; box-shadow:inset 0 0 0 1px #000;
  }
  #controls::-webkit-scrollbar-thumb:hover{ background:linear-gradient(180deg,#3a3a3a,#4a4a4a) }

  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  @media (max-width: 900px){ .row, .row-3{grid-template-columns:1fr} }
  label{display:block; font-size:14px; color:#9a9a9a; margin:10px 0 8px}
  input[type=text], textarea, select{
    width:100%; background:#0f0f0f; border:1.2px solid #242424; color:#f0f0f0;
    padding:14px; border-radius:12px; outline:none; font-size:16px;
  }
  textarea{min-height:72px; resize:vertical}
  input[type=range]{width:100%}
  input[type=color]{width:100%; height:46px; padding:0; border:none; background:#0f0f0f; border-radius:10px}
  .btn{background:#f5f5f5; color:#111; border:none; padding:14px 16px; border-radius:12px; font-weight:800; cursor:pointer}
  .btn.secondary{background:#1c1c1c; color:#eaeaea; border:1px solid #2a2a2a}

  .preview-area{display:grid; grid-auto-rows:1fr; gap:14px; align-content:start}
  @media (max-width: 900px){ .preview-area{ grid-template-columns: 1fr !important; } }
  canvas.preview{width:100%; height:auto; background:#000; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.45); cursor:pointer; touch-action:manipulation}

  .tips{font-size:13px; color:#b5b5b5; background:#0f0f0f; border:1px dashed #2a2a2a; padding:12px; border-radius:12px}
  .checkbox{display:flex; align-items:center; gap:10px; font-size:14px; color:#bdbdbd}
  .stories-fields{display:grid; gap:12px; margin-top:10px}
  .story-field{display:grid; gap:10px; padding:12px; border:1px dashed #2a2a2a; border-radius:12px; background:#101010}
  .story-header{display:flex; justify-content:space-between; align-items:center; font-weight:700; color:#d8d8d8}
  .story-counters{display:flex; gap:16px; color:#8a8a8a; font-size:13px}
  .toolbar{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(18,18,18,0) 0%, rgba(18,18,18,1) 30%); padding-top:10px}

  /* PIP mini preview (mobile, na aba Ajustes) */
  .pip{ display:none; position:fixed; right:12px; bottom:78px; width:min(36vw, 160px); aspect-ratio:9/16;
        background:#000; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.5); border:1px solid #1f1f1f; z-index:9; }
  .pip canvas{width:100%; height:100%; border-radius:12px; display:block}
  .pip .label{position:absolute; top:6px; left:8px; font-size:12px; background:#000a; padding:2px 6px; border-radius:999px}
  @media (max-width: 900px){ body[data-tab="ajustes"] .pip{ display:block } }
</style>
</head>
<body data-tab="preview">
  <!-- Abas (mobile) -->
  <div class="tabs">
    <button class="tab-btn active" id="tabPreview">Preview</button>
    <button class="tab-btn" id="tabAjustes">Ajustes</button>
  </div>

  <!-- Painel de Ajustes (esquerda) -->
  <section class="panel" id="controls">
    <h2>Ajustes</h2>
    <div class="row">
      <div>
        <label for="storyCount">Número de slides</label>
        <input id="storyCount" type="range" min="1" max="7" value="3" />
        <span id="storyCountLabel">3</span>
      </div>
      <div>
        <label for="format">Formato</label>
        <select id="format">
          <option value="story">Stories 1080×1920 (9:16)</option>
          <option value="carousel">Carrossel 1080×1350 (4:5)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="bgColor">Cor de fundo</label>
        <input id="bgColor" type="color" value="#000000" />
      </div>
      <div>
        <label for="fontFamily">Fonte</label>
        <select id="fontFamily">
          <option value="Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto">Inter / System</option>
          <option value="Arial Black, Arial, Helvetica, sans-serif">Arial Black</option>
          <option value="Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif">Impact</option>
          <option value="Montserrat, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto">Montserrat</option>
          <option value="Poppins, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto">Poppins</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="align">Alinhamento (horizontal)</label>
        <select id="align">
          <option value="center">Centralizado</option>
          <option value="left">Esquerda</option>
          <option value="right">Direita</option>
        </select>
      </div>
      <div>
        <label for="signature">Assinatura</label>
        <input id="signature" type="text" placeholder="@seuuser" value="@filippesr" />
      </div>
    </div>

    <div class="row-3">
      <div>
        <label for="hSize">Tamanho Headline</label>
        <input id="hSize" type="range" min="36" max="160" value="96" />
      </div>
      <div>
        <label for="sSize">Tamanho Subheadline</label>
        <input id="sSize" type="range" min="24" max="96" value="48" />
      </div>
      <div>
        <label for="lineHeight">Altura de Linha</label>
        <input id="lineHeight" type="range" min="1.0" max="1.6" value="1.2" step="0.05" />
      </div>
    </div>

    <div class="row">
      <div class="checkbox"><input id="uppercase" type="checkbox" checked /> <label for="uppercase">Headline em CAIXA ALTA</label></div>
      <div class="checkbox"><input id="safe" type="checkbox" /> <label for="safe">Guias de área segura</label></div>
    </div>

    <div class="row">
      <div class="checkbox"><input id="showIndicator" type="checkbox" checked /> <label for="showIndicator">Mostrar indicador de deslize (exceto no último)</label></div>
      <div>
        <label for="indicatorText">Texto do indicador</label>
        <input id="indicatorText" type="text" value="deslize →" />
      </div>
    </div>

    <div class="stories-fields" id="storiesFields"></div>

    <div class="tips">No mobile use as abas acima para alternar <b>Preview</b> | <b>Ajustes</b>. O mini‑preview (PIP) mostra em tempo real o slide ativo.</div>

    <div class="toolbar">
      <button class="btn" id="downloadAllBtn" style="width:100%">Baixar Todos</button>
    </div>
  </section>

  <!-- Preview (direita) -->
  <section class="preview-wrap">
    <div class="preview-area" id="previewArea"></div>
  </section>

  <!-- Mini preview flutuante (PIP) -->
  <div class="pip" id="pip">
    <span class="label">Preview</span>
    <canvas id="pipCanvas"></canvas>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id)
  const previewArea = $('previewArea')
  const wrap = document.querySelector('.preview-wrap')
  const fieldsWrap = $('storiesFields')
  const tabPreview = $('tabPreview')
  const tabAjustes = $('tabAjustes')
  const pip = $('pip')
  const pipCanvas = $('pipCanvas')
  let currentSlideIndex = 0

  // Tabs (mobile)
  function setTab(tab){
    document.body.setAttribute('data-tab', tab)
    if(tabPreview && tabAjustes){
      tabPreview.classList.toggle('active', tab==='preview')
      tabAjustes.classList.toggle('active', tab==='ajustes')
    }
    localStorage.setItem('seq_tab', tab)
    setTimeout(()=>{ renderAll() }, 0)
  }
  if(tabPreview && tabAjustes){
    tabPreview.addEventListener('click', ()=> setTab('preview'))
    tabAjustes.addEventListener('click', ()=> setTab('ajustes'))
    setTab(localStorage.getItem('seq_tab') || 'preview')
  }

  function dims(){
    const f = $('format').value
    if(f==='carousel') return {W:1080, H:1350, ratio:1350/1080}
    return {W:1080, H:1920, ratio:1920/1080}
  }

  function ensureFields(){
    const count = parseInt($('storyCount').value,10)
    $('storyCountLabel').textContent = count
    const existing = fieldsWrap.querySelectorAll('.story-field')
    for(let i=existing.length; i<count; i++){
      const div = document.createElement('div')
      div.className = 'story-field'
      div.innerHTML = `
        <div class="story-header">
          <div>Slide ${i+1}</div>
          <div class="story-counters">
            <small id="hchars-${i}">H:0</small>
            <small id="schars-${i}">S:0</small>
          </div>
        </div>
        <input id="h-${i}" type="text" placeholder="Headline do slide ${i+1}" />
        <textarea id="s-${i}" placeholder="Subheadline do slide ${i+1}"></textarea>
      `
      fieldsWrap.appendChild(div)
      const hi = div.querySelector('#h-'+i)
      const si = div.querySelector('#s-'+i)
      const focus = ()=>{ currentSlideIndex = i; renderAll() }
      hi.addEventListener('focus', focus)
      si.addEventListener('focus', focus)
      hi.addEventListener('input', renderAll, {passive:true})
      si.addEventListener('input', renderAll, {passive:true})
    }
    for(let i=existing.length-1; i>=count; i--){
      existing[i].remove()
    }
    if(currentSlideIndex >= count) currentSlideIndex = count-1
  }

  function readTexts(){
    const count = parseInt($('storyCount').value,10)
    const arr = []
    for(let i=0;i<count;i++){
      const h = ($('h-'+i)?.value || '').trim()
      const s = ($('s-'+i)?.value || '').trim()
      arr.push({h, s})
      const hC = $('hchars-'+i), sC = $('schars-'+i)
      if(hC) hC.textContent = 'H:'+ h.length
      if(sC) sC.textContent = 'S:'+ s.length
    }
    return arr
  }

  function hexToRgb(hex){
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)
    if(!m) return {r:0,g:0,b:0}
    return {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)}
  }
  function luminance({r,g,b}){
    const srgb = [r/255,g/255,b/255].map(v => v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4))
    return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2]
  }

  function breakLines(ctx, text, maxWidth){
    const words = text.split(/\s+/).filter(Boolean)
    const lines = []
    let line = ''
    for(const w of words){
      const test = line ? line + ' ' + w : w
      if(ctx.measureText(test).width > maxWidth){
        if(line) lines.push(line)
        line = w
      }else{
        line = test
      }
    }
    if(line) lines.push(line)
    return lines
  }

  function drawSlide(data, options){
    const {W,H} = dims()
    const cvs = document.createElement('canvas')
    cvs.width = W
    cvs.height = H
    const ctx = cvs.getContext('2d')

    const bgHex = $('bgColor').value || '#000000'
    const bg = bgHex
    const lum = luminance(hexToRgb(bgHex))
    const fg = lum < 0.5 ? '#ffffff' : '#000000'
    const muted = lum < 0.5 ? '#d0d0d0' : '#444444'

    ctx.fillStyle = bg
    ctx.fillRect(0,0,W,H)

    if(options.safe){
      const margin = Math.floor(Math.min(W,H)*0.1)
      ctx.save()
      ctx.strokeStyle = fg
      ctx.globalAlpha=.18
      ctx.setLineDash([12,12])
      ctx.strokeRect(margin, margin, W-2*margin, H-2*margin)
      ctx.setLineDash([])
      ctx.globalAlpha=1
      ctx.restore()
    }

    const padding = Math.floor(Math.min(W,H)*0.08)
    const textMaxWidth = W - padding*2
    const align = options.align
    ctx.textAlign = align==='center' ? 'center' : align==='right' ? 'right' : 'left'
    const x = align==='center' ? W/2 : align==='right' ? W - padding : padding

    const headline = (options.uppercase ? (data.h||('Slide')).toUpperCase() : (data.h||('Slide')))
    ctx.font = `900 ${options.hSize}px ${options.font}`
    const HL = breakLines(ctx, headline, textMaxWidth)
    const hLH = options.hSize * options.lh
    const hBlock = HL.length * hLH

    ctx.font = `500 ${options.sSize}px ${options.font}`
    const SL = data.s ? breakLines(ctx, data.s, textMaxWidth) : []
    const sLH = options.sSize * 1.25
    const sBlock = SL.length * sLH

    const sigSize = Math.max(16, Math.round(Math.min(W,H)*0.033))
    const sigBlock = options.signature ? sigSize * 1.2 : 0

    const spacing1 = HL.length && SL.length ? Math.floor(options.hSize*0.22) : 0
    const spacing2 = options.signature ? Math.floor(options.sSize*0.55) : 0

    const totalBlock = hBlock + spacing1 + sBlock + spacing2 + sigBlock

    let y = (H - totalBlock)/2

    ctx.fillStyle = fg
    ctx.font = `900 ${options.hSize}px ${options.font}`
    for(const line of HL){
      y += hLH
      ctx.fillText(line, x, y)
    }

    if(SL.length){
      y += spacing1
      ctx.fillStyle = muted
      ctx.font = `500 ${options.sSize}px ${options.font}`
      for(const line of SL){
        y += sLH
        ctx.fillText(line, x, y)
      }
    }

    if(options.signature){
      y += spacing2
      ctx.fillStyle = muted
      ctx.font = `600 ${sigSize}px ${options.font}`
      y += sigSize
      ctx.fillText(options.signature, x, y)
    }

    if(options.showIndicator && !options.isLast){
      ctx.save()
      ctx.font = `700 ${Math.max(16, Math.round(Math.min(W,H)*0.034))}px ${options.font}`
      ctx.textAlign = 'center'
      ctx.textBaseline = 'alphabetic'
      ctx.fillStyle = muted
      const indicator = options.indicatorText || 'deslize →'
      const iy = H - Math.floor(padding*0.6)
      ctx.fillText(indicator, W/2, iy)
      ctx.restore()
    }

    return cvs
  }

  function layoutGrid(canvases){
    const gap = 14
    const w = wrap.clientWidth - 24
    const count = canvases.length
    const ratio = dims().ratio
    if(count===0) return

    const isMobile = window.matchMedia('(max-width: 900px)').matches
    if(isMobile){
      const cw = Math.max(140, w)
      const ch = Math.floor(cw * ratio)
      previewArea.style.gridTemplateColumns = '1fr'
      const thumbs = previewArea.querySelectorAll('canvas.preview')
      thumbs.forEach((thumb, i)=>{
        thumb.width = cw
        thumb.height = ch
        const tctx = thumb.getContext('2d')
        tctx.clearRect(0,0,cw,ch)
        tctx.drawImage(canvases[i], 0,0, cw, ch)
      })
      return
    }

    // Desktop
    const minCell = 220, maxCell = 520
    let cols = Math.min(count, Math.max(1, Math.floor((w + gap) / (minCell + gap))))
    function cellWidthFor(cols){ return Math.min(maxCell, Math.floor((w - gap*(cols-1)) / cols)) }
    let cw = cellWidthFor(cols)
    while(cols < count){
      const nextCw = cellWidthFor(cols+1)
      if(nextCw >= minCell){ cols += 1; cw = nextCw } else break
    }

    previewArea.style.gridTemplateColumns = `repeat(${cols}, ${cw}px)`
    const ch = Math.floor(cw * ratio)
    const thumbs = previewArea.querySelectorAll('canvas.preview')
    thumbs.forEach((thumb, i)=>{
      thumb.width = cw
      thumb.height = ch
      const tctx = thumb.getContext('2d')
      tctx.clearRect(0,0,cw,ch)
      tctx.drawImage(canvases[i], 0,0, cw, ch)
    })
  }

  function renderAll(){
    ensureFields()
    previewArea.innerHTML = ''
    const texts = readTexts()
    const canvases = []
    const total = texts.length
    texts.forEach((obj, i)=>{
      const full = drawSlide(obj, {
        safe: $('safe').checked,
        font: $('fontFamily').value,
        align: $('align').value,
        hSize: +$('hSize').value,
        sSize: +$('sSize').value,
        lh: +$('lineHeight').value,
        uppercase: $('uppercase').checked,
        signature: $('signature').value.trim(),
        showIndicator: $('showIndicator').checked,
        indicatorText: $('indicatorText').value.trim(),
        isLast: i === total-1
      })
      canvases.push(full)
      const thumb = document.createElement('canvas')
      thumb.className = 'preview'
      thumb.title = `Baixar slide ${i+1}`
      previewArea.appendChild(thumb)
      thumb.addEventListener('click',()=>{
        const a = document.createElement('a')
        a.download = `slide-${i+1}.png`
        a.href = full.toDataURL('image/png')
        a.click()
      })
    })
    layoutGrid(canvases)
    previewArea._fullCanvases = canvases

    // Atualiza mini-preview (PIP)
    const w = pip.clientWidth || 120
    const h = Math.floor(w * dims().ratio)
    pipCanvas.width = w
    pipCanvas.height = h
    const pctx = pipCanvas.getContext('2d')
    pctx.clearRect(0,0,w,h)
    const idx = Math.max(0, Math.min(currentSlideIndex, canvases.length-1))
    if(canvases[idx]) pctx.drawImage(canvases[idx], 0,0, w, h)
    pip.onclick = ()=> document.body.setAttribute('data-tab','preview')
  }

  async function downloadAll(){
    const canvases = previewArea._fullCanvases || []
    for(let i=0;i<canvases.length;i++){
      await new Promise(res=>setTimeout(res, 140))
      const a = document.createElement('a')
      a.download = `slide-${i+1}.png`
      a.href = canvases[i].toDataURL('image/png')
      document.body.appendChild(a)
      a.click()
      a.remove()
    }
  }

  // Observa resize p/ recalcular layout
  const ro = new ResizeObserver(()=>{
    const texts = readTexts()
    const canvases = texts.map((obj, i, arr) => drawSlide(obj, {
      safe: $('safe').checked,
      font: $('fontFamily').value, align: $('align').value,
      hSize: +$('hSize').value, sSize: +$('sSize').value, lh: +$('lineHeight').value,
      uppercase: $('uppercase').checked, signature: $('signature').value.trim(),
      showIndicator: $('showIndicator').checked, indicatorText: $('indicatorText').value.trim(),
      isLast: i === arr.length-1
    }))
    layoutGrid(canvases)
    previewArea._fullCanvases = canvases

    // Redesenha PIP
    const w = pip.clientWidth || 120
    const h = Math.floor(w * dims().ratio)
    pipCanvas.width = w
    pipCanvas.height = h
    const pctx = pipCanvas.getContext('2d')
    pctx.clearRect(0,0,w,h)
    const idx = Math.max(0, Math.min(currentSlideIndex, canvases.length-1))
    if(canvases[idx]) pctx.drawImage(canvases[idx], 0,0, w, h)
  })
  ro.observe(wrap)

  // Inputs
  document.getElementById('controls').addEventListener('input', (e)=>{
    if(e.target && /^(h|s)-\d+/.test(e.target.id)){
      currentSlideIndex = parseInt(e.target.id.split('-')[1],10) || 0
    }
    renderAll()
  }, {passive:true})
  document.getElementById('controls').addEventListener('change', renderAll)
  document.getElementById('downloadAllBtn').addEventListener('click', downloadAll)

  // Inicializa
  ensureFields()
  renderAll()
})()
</script>
</body>
</html>
