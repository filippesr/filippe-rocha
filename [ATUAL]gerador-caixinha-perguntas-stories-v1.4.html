<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Gerador – Caixinha de Perguntas (Stories) • v1.4</title>
<style>
  :root{
    --bg:#0a0a0a; --fg:#fafafa; --panel:#121212;
    --ig-sticker-top:#2c2c2e;
    --ig-sticker-bottom:#ffffff;
    --ig-sticker-text:#ffffff;
    --ig-question-text:#2a2a2a;
    --danger:#ff5050;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    color:var(--fg); background:#0b0b0b;
    display:grid; grid-template-columns:minmax(360px,520px) 1fr; grid-template-areas:"controls preview";
    gap:16px; padding:16px; height:100vh;
  }
  @media (max-width: 900px){
    body{grid-template-columns:1fr; grid-template-rows:auto 1fr; grid-template-areas:"controls" "preview";
         gap:10px; padding:10px; height:100svh;}
  }

  /* Painéis */
  .panel{background:var(--panel); border:1px solid #1f1f1f; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:auto}
  #controls{ grid-area:controls; scrollbar-width: thin; scrollbar-color: #3a3a3a #101010; }
  #controls::-webkit-scrollbar{ width:12px }
  #controls::-webkit-scrollbar-track{ background:linear-gradient(180deg,#101010,#0b0b0b); border-radius:10px }
  #controls::-webkit-scrollbar-thumb{ background:linear-gradient(180deg,#2a2a2a,#3c3c3c); border-radius:10px; border:2px solid #101010; box-shadow:inset 0 0 0 1px #000; }
  #controls::-webkit-scrollbar-thumb:hover{ background:linear-gradient(180deg,#3a3a3a,#4a4a4a) }

  .preview-wrap{ grid-area:preview; background:#121212; border:1px solid #1f1f1f; border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:auto; }
  .preview-area{ min-height: calc(100vh - 32px); display:grid; place-items:center; }
  @media (max-width: 900px){ .preview-area{ min-height: calc(100svh - 20px); } }

  .panel h2{margin:4px 0 12px; font-size:18px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  @media (max-width: 900px){ .row, .row-3{grid-template-columns:1fr} }
  label{display:block; font-size:14px; color:#9a9a9a; margin:10px 0 8px}

  input[type=text], textarea, select{
    width:100%; background:#0f0f0f; border:1.2px solid #242424; color:#f0f0f0;
    padding:14px; border-radius:12px; outline:none; font-size:16px;
  }
  input[type=text].error{ border-color: var(--danger); box-shadow: 0 0 0 3px rgba(255,80,80,.15); }
  .alert{ display:none; font-size:12px; color:var(--danger); margin-top:6px }
  .alert.show{ display:block }

  textarea{min-height:120px; resize:vertical}
  input[type=range]{width:100%}
  .btn{background:#f5f5f5; color:#111; border:none; padding:14px 16px; border-radius:12px; font-weight:800; cursor:pointer}

  /* Canvas responsivo: sempre cabe na tela */
  canvas.preview{
    aspect-ratio: 1080 / 1920;
    height: min( calc(100vh - 140px), 90vh );
    max-height: calc(100svh - 140px);
    width: auto; max-width: min(100%, 56.25vh);
    display:block; margin:0 auto; background:#000; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.45); cursor:pointer;
  }
  @media (max-width: 900px){
    canvas.preview{ height: min( calc(100svh - 160px), 88svh ); max-width: 100%; }
  }

  .tips{font-size:13px; color:#b5b5b5; background:#0f0f0f; border:1px dashed #2a2a2a; padding:12px; border-radius:12px}
</style>
</head>
<body>
  <!-- Menu / Controles (esquerda) -->
  <section class="panel" id="controls">
    <h2>Ajustes</h2>

    <div>
      <label for="tema">Campo 1 – Tema (título da caixinha) <small id="temaCount" style="color:#777">(0/30)</small></label>
      <input id="tema" type="text" placeholder="Ex.: Bate bola" value="Bate bola" maxlength="90" />
      <div id="temaAlert" class="alert">Máx. <b>30</b> caracteres. O excesso não será exibido no story.</div>
    </div>

    <div>
      <label for="pergunta">Campo 2 – Pergunta <small id="pergCount" style="color:#777">(0/60)</small></label>
      <input id="pergunta" type="text" placeholder="Escreva a pergunta..." value="Arrependimento" maxlength="200" />
      <div id="pergAlert" class="alert">Máx. <b>60</b> caracteres. O excesso não será exibido no story.</div>
    </div>

    <div>
      <label for="resposta">Campo 3 – Resposta</label>
      <textarea id="resposta" placeholder="Digite a resposta...">Não tenho.
Me perdoo por todas as situações que fiz algo ou aceitei algo que hoje faria diferente. Precisamos entender que grande parte da nossa maturidade vem com erros. Naquele momento, você não tinha como pensar com a cabeça que você tem agora e fim.

Melhor do que ficar arrependida é aprender e não repetir.</textarea>
    </div>

    <div class="row">
      <div>
        <label for="fontFamily">Fonte da resposta</label>
        <select id="fontFamily">
          <option value="Georgia, 'Times New Roman', serif">Serif (estilo do modelo)</option>
          <option value="Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial">Inter / System</option>
        </select>
      </div>
      <div>
        <label for="align">Alinhamento</label>
        <select id="align">
          <option value="center">Centralizado</option>
          <option value="left">Esquerda</option>
          <option value="right">Direita</option>
        </select>
      </div>
    </div>

    <div class="row-3">
      <div>
        <label for="txtSize">Tamanho da resposta</label>
        <input id="txtSize" type="range" min="28" max="64" value="44" />
      </div>
      <div>
        <label for="lineHeight">Altura de linha</label>
        <input id="lineHeight" type="range" min="1.1" max="1.8" step="0.05" value="1.35" />
      </div>
      <div>
        <label for="stickerWidth">Largura da caixinha</label>
        <input id="stickerWidth" type="range" min="600" max="980" value="840" />
      </div>
    </div>

    <div class="tips">Agora o **Enter** no Campo 3 cria quebra de parágrafo real (com um espaçamento discreto). Tema 30c, Pergunta 60c.</div>
    <button class="btn" id="downloadBtn" style="width:100%">Baixar PNG</button>
  </section>

  <!-- Preview (direita) -->
  <section class="preview-wrap">
    <div class="preview-area"><canvas id="canvas" class="preview"></canvas></div>
  </section>

<script>
(function(){
  const $ = (id)=>document.getElementById(id)
  const cvs = $('canvas')
  const ctx = cvs.getContext('2d')

  const W = 1080, H = 1920 // Stories base
  cvs.width = W; cvs.height = H

  // Utils
  function roundRect(ctx, x, y, w, h, radii, fill, stroke){
    let r = {tl:0,tr:0,br:0,bl:0, ...radii}
    ctx.beginPath()
    ctx.moveTo(x+r.tl, y)
    ctx.lineTo(x+w-r.tr, y)
    ctx.quadraticCurveTo(x+w, y, x+w, y+r.tr)
    ctx.lineTo(x+w, y+h-r.br)
    ctx.quadraticCurveTo(x+w, y+h, x+w-r.br, y+h)
    ctx.lineTo(x+r.bl, y+h)
    ctx.quadraticCurveTo(x, y+h, x, y+h-r.bl)
    ctx.lineTo(x, y+r.tl)
    ctx.quadraticCurveTo(x, y, x+r.tl, y)
    ctx.closePath()
    if(fill) ctx.fill()
    if(stroke) ctx.stroke()
  }

  // Quebra com preservação explícita de parágrafos (cada \n vira nova linha)
  function breakLinesPreserveNewlines(ctx, text, maxWidth){
    const result = []
    const paragraphs = (text||'').split(/\\r?\\n/)  // preserva linhas vazias
    paragraphs.forEach((para, idx)=>{
      if(para.length === 0){
        // linha vazia explícita
        result.push('')
      }else{
        const words = para.split(/\\s+/).filter(Boolean)
        let line = ''
        for(let w of words){
          if(ctx.measureText(w).width > maxWidth){
            // fallback por caracteres
            let buf=''
            for(const ch of w){
              const test = buf + ch
              if(ctx.measureText(test).width > maxWidth){
                if(buf){ result.push(buf); buf = ch }
                else { result.push(ch) }
              } else { buf = test }
            }
            w = buf || ''
            if(!w) continue
          }
          const testLine = line ? line + ' ' + w : w
          if(ctx.measureText(testLine).width > maxWidth){
            if(line) result.push(line)
            line = w
          } else {
            line = testLine
          }
        }
        if(line) result.push(line)
      }
      // adiciona nova linha (uma) entre parágrafos quando não é o último
      if(idx < paragraphs.length - 1) result.push('')
    })
    return result
  }

  // Quebra/ajuste da pergunta mantendo altura do sticker
  function breakQuestion(ctx, text, maxWidth, qH){
    let qFont = 44
    const qLineHFactor = 1.15
    let qLines = []
    while(qFont >= 22){
      ctx.font = `600 ${qFont}px Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial`
      qLines = breakLinesPreserveNewlines(ctx, text, maxWidth)
      const qLH = qFont * qLineHFactor
      const qTotal = qLines.length * qLH
      if(qTotal <= qH - 24) break
      qFont -= 1
    }
    return { qFont, qLines, qLH: qFont * qLineHFactor, qBlockH: Math.min(qH - 24, (qLines.length * (qFont * qLineHFactor))) }
  }

  function draw(){
    // Fundo preto
    ctx.fillStyle = '#000000'
    ctx.fillRect(0,0,W,H)

    const TEMA_LIMIT = 30
    const PERG_LIMIT = 60

    // Tema com validação
    let temaRaw = $('tema').value || ''
    const temaLen = temaRaw.length
    const temaAlert = $('temaAlert'), temaInput = $('tema'), temaCount = $('temaCount')
    temaCount.textContent = `(${temaLen}/${TEMA_LIMIT})`
    if(temaLen > TEMA_LIMIT){ temaInput.classList.add('error'); temaAlert.classList.add('show') }
    else { temaInput.classList.remove('error'); temaAlert.classList.remove('show') }
    const tema = temaRaw.slice(0, TEMA_LIMIT) || 'Perguntas'

    // Pergunta com limite
    let perguntaRaw = $('pergunta').value || ''
    const pergLen = perguntaRaw.length
    const pergAlert = $('pergAlert'), pergInput = $('pergunta'), pergCount = $('pergCount')
    pergCount.textContent = `(${pergLen}/${PERG_LIMIT})`
    if(pergLen > PERG_LIMIT){ pergInput.classList.add('error'); pergAlert.classList.add('show') }
    else { pergInput.classList.remove('error'); pergAlert.classList.remove('show') }
    perguntaRaw = perguntaRaw.slice(0, PERG_LIMIT)

    const resposta = ($('resposta').value || '')

    const fontResp = $('fontFamily').value
    const align = $('align').value
    const baseSize = +$('txtSize').value
    const lh = +$('lineHeight').value
    const stickerW = +$('stickerWidth').value

    // Dimensões do sticker
    const sw = Math.min(stickerW, W-120)
    const sx = Math.round((W - sw)/2)
    const headerH = 120
    const qH = 160
    const radius = 36

    // Centralização vertical do bloco
    const topMargin = 120, bottomMargin = 140
    const availH = H - topMargin - bottomMargin

    // Pergunta quebrada
    const qPadX = 56
    const qMaxWidth = sw - qPadX*2
    const { qFont, qLines, qLH, qBlockH } = breakQuestion(ctx, (perguntaRaw.trim() || ' '), qMaxWidth, qH)

    // Resposta quebrada preservando newlines com espaçamento visual
    const gap = 36
    const maxResponseH = availH - (headerH + qH + gap)
    let fontSize = baseSize
    let respLines = []
    const paddingX = 120
    const maxWidth = W - paddingX*2
    while(fontSize >= 22){
      ctx.font = `400 ${fontSize}px ${fontResp}`
      respLines = breakLinesPreserveNewlines(ctx, resposta, maxWidth)
      const lineH = fontSize * lh
      const totalH = respLines.length * lineH
      if(totalH <= maxResponseH) break
      fontSize -= 2
    }
    const lineH = fontSize * lh
    const respBlockH = respLines.length * lineH

    // Altura total do grupo e topo para centralizar
    const groupH = headerH + qH + gap + respBlockH
    const groupTop = topMargin + Math.max(0, (availH - groupH)/2)

    // ---- Render ----
    const sy = groupTop

    // Header escuro + tema
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ig-sticker-top').trim() || '#2c2c2e'
    roundRect(ctx, sx, sy, sw, headerH, {tl:radius, tr:radius, br:0, bl:0}, true, false)
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ig-sticker-text').trim() || '#ffffff'
    ctx.font = '700 44px Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial'
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle'
    ctx.fillText(tema, sx + sw/2, sy + headerH/2)

    // Pergunta
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ig-sticker-bottom').trim() || '#ffffff'
    roundRect(ctx, sx, sy+headerH, sw, qH, {tl:0, tr:0, br:radius, bl:radius}, true, false)
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ig-question-text').trim() || '#2a2a2a'
    ctx.textAlign = 'center'; ctx.textBaseline = 'top'
    ctx.font = `600 ${qFont}px Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial`
    let qy = sy + headerH + (qH - qBlockH)/2
    for(const l of qLines){
      ctx.fillText(l, sx + sw/2, Math.round(qy))
      qy += qLH
    }

    // Sombra
    ctx.save()
    ctx.shadowColor = 'rgba(0,0,0,.45)'
    ctx.shadowBlur = 40
    ctx.shadowOffsetY = 10
    ctx.fillStyle = 'transparent'
    roundRect(ctx, sx, sy, sw, headerH+qH, {tl:radius,tr:radius,br:radius,bl:radius}, true, false)
    ctx.restore()

    // Resposta (com parágrafos)
    const yRespTop = sy + headerH + qH + gap
    let y = yRespTop
    ctx.fillStyle = '#ffffff'
    ctx.textAlign = (align==='center'?'center':align==='right'?'right':'left')
    ctx.textBaseline = 'alphabetic'
    ctx.font = `400 ${fontSize}px ${fontResp}`
    const x = (align==='center'? W/2 : align==='right'? (W - paddingX) : paddingX)
    for(const ln of respLines){
      y += lineH
      ctx.fillText(ln, x, Math.round(y))
    }
  }

  // Eventos
  document.getElementById('controls').addEventListener('input', draw, {passive:true})
  document.getElementById('controls').addEventListener('change', draw)
  document.getElementById('downloadBtn').addEventListener('click', ()=>{
    const a = document.createElement('a')
    a.download = 'story-caixinha.png'
    a.href = cvs.toDataURL('image/png')
    a.click()
  })
  cvs.addEventListener('click', ()=>{
    const a = document.createElement('a')
    a.download = 'story-caixinha.png'
    a.href = cvs.toDataURL('image/png')
    a.click()
  })

  draw()
})()
</script>
</body>
</html>
